{% include 'includes/head.html' %}
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        <!-- Menu -->
        {% include "includes/aside.html" %}
        <!-- / Menu -->

        <!-- Layout container -->
        <div class="layout-page">
          <!-- Navbar -->
          {% include "includes/navbar.html" %}
          <!-- Content wrapper -->
          <div class="content-wrapper">

            <!-- Content -->
            <div class="container-xxl flex-grow-1 container-p-y">
              <div class="row">
                <div class="col-lg-4">
                  <form class="signature-pad-form" action="#" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <h4>Sign Document</h4>
                    <p><b>Signature</b></p>
                    <input type="hidden" id="document_id" name="document_id" value="{{doc_ob.id}}">
                    <canvas height="100" width="300" class="signature-pad"></canvas>
                    <p><a href="#" class="clear-button">Clear</a></p>
                    <button class="submit-button" type="submit">SUBMIT</button>
                  </form>
                </div>

                <div class="col-lg-7 offset-lg-1">
                  <embed src="{{doc_ob.document_file.file.url}}#toolbar=0" class="mt-5 mt-lg-0 w-100"
                  height="400px" type="application/pdf"/> 
                </div>

              </div>
            </div>
            <!--/ Content -->

            <!-- Footer -->
            {% include "includes/footer_aside.html" %}
            <!-- / Footer -->

            <div class="content-backdrop fade"></div>
          </div>
          <!--/ Content wrapper -->
        </div>

        <!--/ Layout container -->
      </div>
    </div>

    <!-- Overlay -->
    <div class="layout-overlay layout-menu-toggle"></div>

    <!-- Drag Target Area To SlideIn Menu On Small Screens -->
    <div class="drag-target"></div>     
    </script>
    <!--/ Layout wrapper -->
    {% include "includes/messages.html" %}
    {% include "includes/footer.html" %}

    <script>
      const canvas = document.querySelector('canvas');
      const form = document.querySelector('.signature-pad-form');
      const clearButton = document.querySelector('.clear-button');

      const ctx = canvas.getContext('2d');
      let writingMode = false;

      const handlePointerDown = (event) => {
        writingMode = true;
        ctx.beginPath();
        const [positionX, positionY] = getCursorPosition(event);
        ctx.moveTo(positionX, positionY);
      }

      const handlePointerUp = () => {
        writingMode = false;
      }

      const handlePointerMove = (event) => {
        if (!writingMode) return
        const [positionX, positionY] = getCursorPosition(event);
        ctx.lineTo(positionX, positionY);
        ctx.stroke();
      }

      const getCursorPosition = (event) => {
        positionX = event.clientX - event.target.getBoundingClientRect().x;
        positionY = event.clientY - event.target.getBoundingClientRect().y;
        return [positionX, positionY];
      }

      canvas.addEventListener('pointerdown', handlePointerDown, {passive: true});
      canvas.addEventListener('pointerup', handlePointerUp, {passive: true});
      canvas.addEventListener('pointermove', handlePointerMove, {passive: true});

      ctx.lineWidth = 3;
      ctx.lineJoin = ctx.lineCap = 'round';

      const clearPad = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      form.addEventListener('submit', (event) => {
        event.preventDefault();
        
        clearPad();
      })
      
      clearButton.addEventListener('click', (event) => {
        event.preventDefault();
        clearPad();
      }) 

      document.querySelector('.submit-button').addEventListener('click', function() {
        var canvas = document.querySelector('canvas');
        var signatureData = canvas.toDataURL(); 
        var documentId = document.querySelector('#document_id').value;
        var url = '/sign_document_detail/' + documentId + '/';
        console.log(signatureData)
        
        var xhr = new XMLHttpRequest();
        xhr.open('POST', url, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        var csrftoken = document.querySelector('input[name=csrfmiddlewaretoken]').value; 
        xhr.setRequestHeader('X-CSRFToken', csrftoken); 
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    console.log('Signature saved successfully!');
                    alertify.set('notifier','position', 'top-right');
                    alertify.success('Signature saved successfully!');
                    setTimeout(function() {
                      window.location.href = '/signed_document/';
                    }, 1200);
                } else {
                  alertify.set('notifier','position', 'top-right');
                  alertify.error('Please try again!!');
                }
            }
        };
        xhr.send('signature_data=' + encodeURIComponent(signatureData) + '&document_id=' + encodeURIComponent(documentId));

    });

    </script>